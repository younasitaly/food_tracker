<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tracciatore Alimenti</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #f4f4f4;
    padding: 15px;
  }
  #loginBox, #mainApp {
    max-width: 600px;
    margin: 60px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  #loginBox h2, #mainApp h2 {
    color: #4CAF50;
    text-align: center;
    margin-bottom: 25px;
  }
  input, button {
    width: 100%;
    padding: 12px 15px;
    margin: 8px 0;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    background-color: #4CAF50;
    border: none;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #45a049;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: center;
    white-space: nowrap;
  }
  th {
    background: #f9f9f9;
  }
  .expired {
    background-color: #ffdddd;
  }
  .expiring-soon {
    background-color: #fff4cc;
  }
  .actions button {
    width: 36px;
    height: 36px;
    margin: 0 3px;
    font-size: 18px;
    padding: 0;
    border-radius: 6px;
    line-height: 1;
  }
  .edit-btn {
    background-color: #2196F3;
  }
  .edit-btn:hover {
    background-color: #0b7dda;
  }
  .delete-btn {
    background-color: #f44336;
  }
  .delete-btn:hover {
    background-color: #da190b;
  }
  .logout-btn {
    position: fixed;
    top: 15px;
    right: 15px;
    padding: 10px 18px;
    font-weight: bold;
    border: none;
    background-color: #f44336;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    z-index: 9999;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  @media (max-width: 600px) {
    table, th, td {
      font-size: 12px;
      padding: 6px 8px;
    }
    input, button {
      font-size: 14px;
      padding: 10px 12px;
    }
    .actions button {
      width: 30px;
      height: 30px;
      font-size: 16px;
    }
  }
</style>
</head>
<body>

<!-- Login -->
<div id="loginBox">
  <h2>üîê Accesso Amministratore</h2>
  <input id="username" placeholder="Username" autocomplete="username" />
  <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
  <button onclick="checkLogin()">Accedi</button>
</div>

<!-- Main App -->
<div id="mainApp" style="display:none;">
  <h2>üç≤ Tracciatore Alimenti</h2>
  <form onsubmit="event.preventDefault(); addItem();">
    <input list="productList" id="itemName" placeholder="Nome prodotto" autocomplete="off" />
    <datalist id="productList"></datalist>
    <input id="datePrepared" type="date" />
    <input id="expiryDate" type="date" />
    <button type="submit">Aggiungi Prodotto</button>
  </form>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Preparato</th>
        <th>Scadenza</th>
        <th>Stato</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody id="itemTable"></tbody>
  </table>
</div>

<button id="logoutBtn" class="logout-btn" style="display:none;">Esci</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc,
    setDoc, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAVmsiSzszfgCEk5qqnX57pGigoQtUafAU",
    authDomain: "food-tracker-fca47.firebaseapp.com",
    projectId: "food-tracker-fca47",
    storageBucket: "food-tracker-fca47.appspot.com",
    messagingSenderId: "769456892190",
    appId: "1:769456892190:web:9c2a2e7d676f1f2d85010f"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const itemsRef = collection(db, "foodItems");
  const namesRef = collection(db, "productNames");

  function $(id) { return document.getElementById(id); }

  // Login check
  window.checkLogin = function() {
    const u = $("username").value.trim();
    const p = $("password").value.trim();

    if (u === "Admin" && p === "Miraggio@46") {
      localStorage.setItem("loggedIn", "yes");
      $("loginBox").style.display = "none";
      $("mainApp").style.display = "block";
      $("logoutBtn").style.display = "block";
      startListening();
    } else {
      alert("Credenziali non valide");
    }
  };

  // Logout
  $("logoutBtn").onclick = function() {
    localStorage.removeItem("loggedIn");
    $("loginBox").style.display = "block";
    $("mainApp").style.display = "none";
    $("logoutBtn").style.display = "none";
  };

  // Add item
  window.addItem = async function() {
    const name = $("itemName").value.trim();
    const prepared = $("datePrepared").value;
    const expiry = $("expiryDate").value;

    if (!name || !prepared || !expiry) {
      alert("Per favore, completa tutti i campi.");
      return;
    }

    await addDoc(itemsRef, { name, prepared, expiry });
    await setDoc(doc(namesRef, name), { name });

    $("itemName").value = "";
    $("datePrepared").value = "";
    $("expiryDate").value = "";
  };

  // Edit item
  window.editItem = async function(id, current) {
    const newName = prompt("Modifica nome prodotto:", current.name);
    const newPrepared = prompt("Modifica data di preparazione:", current.prepared);
    const newExpiry = prompt("Modifica data di scadenza:", current.expiry);
    if (newName && newPrepared && newExpiry) {
      await setDoc(doc(db, "foodItems", id), { name: newName, prepared: newPrepared, expiry: newExpiry });
      await setDoc(doc(namesRef, newName), { name: newName });
    }
  };

  // Delete item
  window.deleteItem = async function(id) {
    if (confirm("Vuoi eliminare questo prodotto?")) {
      await deleteDoc(doc(db, "foodItems", id));
    }
  };

  // Format date as dd/mm/yyyy
  function formatDate(dateStr) {
    const [y,m,d] = dateStr.split("-");
    return `${d}/${m}/${y}`;
  }

  // Render items to table
  function renderItems(snapshot) {
    const table = $("itemTable");
    table.innerHTML = "";
    const today = new Date();
    today.setHours(0,0,0,0);

    snapshot.forEach(docSnap => {
      const item = docSnap.data();
      const id = docSnap.id;
      const expiryDate = new Date(item.expiry);
      const daysLeft = Math.floor((expiryDate - today) / (1000*60*60*24));

      let status = "", rowClass = "";
      if (expiryDate < today) {
        status = "Scaduto"; rowClass = "expired";
      } else if (daysLeft <= 1) {
        status = "In Scadenza"; rowClass = "expiring-soon";
      } else {
        status = `${daysLeft} giorni rimasti`;
      }

      const row = document.createElement("tr");
      row.className = rowClass;
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${formatDate(item.prepared)}</td>
        <td>${formatDate(item.expiry)}</td>
        <td>${status}</td>
        <td class="actions">
          <button class="edit-btn" title="Modifica" onclick='editItem("${id}", ${JSON.stringify(item)})'>‚úèÔ∏è</button>
          <button class="delete-btn" title="Elimina" onclick='deleteItem("${id}")'>üóëÔ∏è</button>
        </td>
      `;
      table.appendChild(row);
    });
  }

  // Render product names for datalist
  function renderProductNames(snapshot) {
    const datalist = $("productList");
    datalist.innerHTML = "";
    snapshot.forEach(docSnap => {
      const name = docSnap.data().name;
      const opt = document.createElement("option");
      opt.value = name;
      datalist.appendChild(opt);
    });
  }

  // Listen to Firestore data changes
  function startListening() {
    onSnapshot(query(itemsRef, orderBy("expiry")), renderItems);
    onSnapshot(query(namesRef, orderBy("name")), renderProductNames);
  }

  // Auto login if already logged in
  if(localStorage.getItem("loggedIn") === "yes") {
    $("loginBox").style.display = "none";
    $("mainApp").style.display = "block";
    $("logoutBtn").style.display = "block";
    startListening();
  }
</script>
</body>
</html>
